<!doctype html>
	<head>
		<meta charset="UTF-8">
		<title>Outta Space</title>
		<link href="style.css" rel="stylesheet" type="text/css">
	</head>

	<body>
		<div align="center">
			<canvas id="game-canvas" width="700" height="500"></canvas>
		</div>
		<script src="../pixi.js/bin/pixi.js"></script>

		<script>
			var Container = PIXI.Container,
				autoDetectRenderer = PIXI.autoDetectRenderer;
				loader = PIXI.loader,
				resources = PIXI.loader.resources,
				TextureCache = PIXI.utils.TextureCache,
				Texture = PIXI.Texture,
				Sprite = PIXI.Sprite,
				Graphics = PIXI.Graphics;

				//create PIXI stage and renderer and add to DOM
				console.log("Create stage!");
				var stage = new Container(),
					renderer = autoDetectRenderer(700, 500, {view:document.getElementById("game-canvas")});
					
				document.body.appendChild(renderer.view);

				//Auto-focus fix
				document.getElementById("game-canvas").setAttribute('tabindex', 0);
				document.getElementById("game-canvas").focus();

				/*var Resource = PIXI.loaders.Resource;
			    Resource.setExtensionLoadType("ogg", Resource.LOAD_TYPE.XHR);

			    //Set default loading type for sound file extensions to be arraybuffer
			    Resource.setExtensionXhrType("ogg", Resource.XHR_RESPONSE_TYPE.BUFFER);*/

				loader
					.add("images/spaceship1.png")
					.add("images/spaceship2.png")
					.add("images/p1ship1.png")
					.add("images/p1ship2.png")
					.add("images/p1ship3.png")
					.add("images/p2ship1.png")
					.add("images/p2ship2.png")
					.add("images/p2ship3.png")
					.add("images/playerfire.png")
					.add("images/enemyfire.png")
					.add("images/arrow-left.png")
					.add("images/arrow-right.png")
					.add("images/enemyship1.png")
					.add("images/enemyship2.png")
					.add("images/enemyship3.png")
					.add("images/enemyship4.png")
					.add("images/enemyship5.png")
					.add("images/enemyship6.png")
					.add("images/enemyship7.png")
					.add("images/enemyship8.png")
					.add("images/enemyship9.png")
					.add("images/enemyship10.png")
					.add("images/enemyship11.png")
					.add("images/enemyship12.png")
					.add("images/explosion1.png")
					.add("images/explosion2.png")
					.add("images/explosion3.png")
					.add("images/explosion4.png")
					.add("images/explosion5.png")
					.add("images/explosion6.png")
					.add("images/explosion7.png")
					.add("images/explosion8.png")
					.add("images/explosion9.png")
					.add("images/explosion10.png")
					.add("images/explosion11.png")
					.add("images/explosion12.png")
					.add("images/explosion13.png")
					.add("images/explosion14.png")
					.add("images/explosion15.png")
					.add("images/explosion16.png")
					.add("images/explosion17.png")
					.add("images/explosion18.png")
					.add("images/explosion19.png")
					.add("images/explosion20.png")
					.add("images/explosion21.png")
					.add("images/explosion22.png")
					.add("images/explosion23.png")
					.add("images/explosion24.png")
					.add("images/explosion25.png")
					.add("images/explosion26.png")
					.add("images/explosion27.png")
					.add("images/explosion28.png")
					.add("images/explosion29.png")
					.add("images/explosion30.png")
					.add("images/explosion31.png")
					.add("images/explosion32.png")
					.add("images/explosion33.png")
					.add("images/explosion34.png")
					.load(setup);


				//Define multiple vars
				var player, playervx, playervy, enemy = [], pfire = [], efire = [], firing, livesTxt, wavesTxt, state, lives, livesNo, wavesNo, tutorialTxt1, tutorialTxt2, splashScene, startLock, startup, splashText, splashImg, gameScene, endGame, gameOverScene, gameoverTxt, gameoverTxt2, titleScene, title, titleText1, titleText2, titleText3, titleText4, titleText5, titleShip, titleShipInit, arrowLeft, arrowRight, shipNo, bgScene, explosion, enemySpin = [];
				var bgm = [], psfx = [], esfx = [], osfx = [], bgmp, sfx1p, sfx2p;
				var bgmtype = { //music type(bgm)
					Startup: 1,
					Title: 2,
					Game: 3,
					Gameover: 4
				};
				var psfxtype = { //music type(player sfx)
					Fire: 1,
					Explode: 2,
					Hit: 3
				};
				var esfxtype = { //music type(enemy sfx)
					Fire: 21,
					Explode: 22,
					Pass: 23,
					Hit: 24
				};
				var osfxtype = {
					Click: 41,
					Shift: 42
				}

				var maxWaveData; //save file for max waves

				function setup(){

					//setup savefile
					maxWaveData = localStorage.getItem("maxWaveData") === null? 0:parseInt(JSON.parse(localStorage.maxWaveData)); //if there's savefile, get it
					console.log("Savefile: " + maxWaveData.toString()); //test

					//Bg container layer
					bgScene = new Container();
					stage.addChild(bgScene);

					//Setup game scene
					gameScene = new Container();
					stage.addChild(gameScene);
					//gameScene.visible = false; //hide game scene in startup

					//Sounds ref
					bgm[0] = new Audio("sounds/bgm1.ogg"); //epic game bgm
					bgm[1] = new Audio("sounds/bgm2.ogg");
					bgm[2] = new Audio("sounds/bgm3.ogg"); //titlescreen bgm
					bgm[3] = new Audio("sounds/bgm4.ogg");
					bgm[4] = new Audio("sounds/bgm5.ogg");
					bgm[5] = new Audio("sounds/bgm6.ogg");

					osfx[0] = new Audio("sounds/mothership.ogg"); //startup sfx
					osfx[1] = new Audio("sounds/ufo.ogg"); //next wave sfx
					osfx[2] = new Audio("sounds/shift.ogg"); //change ship sfx
					osfx[3] = new Audio("sounds/select.ogg"); //select sfx

					psfx[0] = new Audio("sounds/fire.ogg"); //player fire
					psfx[1] = new Audio("sounds/explosion2.ogg"); //explode player
					psfx[2] = new Audio("sounds/gameover.ogg"); 
					psfx[3] = new Audio("sounds/hit.ogg"); //hit sfx

					esfx[0] = new Audio("sounds/fire.ogg");
					esfx[1] = new Audio("sounds/explosion1.ogg");
					esfx[2] = new Audio("sounds/whoosh1.ogg");
					esfx[3] = new Audio("sounds/hit.ogg");


					//create bg
					var spaceTexture = Texture.fromImage("images/space-texture.jpg");
					space = new PIXI.extras.TilingSprite(spaceTexture, 700, 500);
					space.position.x = 0;
					space.position.y = 0;
					space.tilePosition.x = 0;
					space.tilePosition.y = 0;
					bgScene.addChild(space);

					//Create fires here
					pfire[0] = new Sprite(resources["images/playerfire.png"].texture);
					efire[0] = new Sprite(resources["images/enemyfire.png"].texture);
					pfire[0].visible = false;
					efire[0].visible = false;

					//test
					pfire[1] = new Sprite(resources["images/playerfire.png"].texture);
					pfire[1].visible = false;
					pfire[2] = new Sprite(resources["images/playerfire.png"].texture);
					pfire[2].visible = false;
					pfire[3] = new Sprite(resources["images/playerfire.png"].texture);
					pfire[3].visible = false;

					gameScene.addChild(pfire[0]);
					gameScene.addChild(pfire[1]);
					gameScene.addChild(pfire[2]);
					gameScene.addChild(pfire[3]);
					gameScene.addChild(efire[0]);



					wavesNo = 1; //set first wave

					//Create enemy wave
					if(wavesNo === 1){
						for(var i = 0; i < 15; i++){
							//enemy[i] = new Sprite(resources["images/enemyship1.png"].texture);
							//enemy[i].x = (800 + (400 * i));
							//enemy[i].y = (50 + ((Math.floor((Math.random() * 400) + 1)))).clamp(15, 400);

							//Generated enemy position
							var eX = (800 + (400 * i)); //generated x val 
							var eY = (50 + ((Math.floor((Math.random() * 400) + 1)))).clamp(15, 400); //generated y val 

							//Enemy animation
							spinEnemy(eX, eY, i);

							//gameScene.addChild(enemy[i]);
						}
					}

					//Create player
					/*player = new Sprite(resources["images/spaceship1.png"].texture);
					player.x = 10;
					player.y = 350;
					player.vx = 0;
					player.vy = 0;
					gameScene.addChild(player);*/
					//shipNo = 1; //test
					//playerAnimate(10, 350); //test
					//player.vx = 0;
					//player.vy = 0;

					//init player movement speed
					playervx = 0;
					playervy = 0;

					//Get keyboard arrow keys
					var left = keyboard(37),
						up = keyboard(38),
						right = keyboard(39),
						down = keyboard(40),
						spacebar = keyboard(32),
						xbtn = keyboard(88);

					//renderer.plugins.interaction.autoPreventDefault = false

					//Left arrow key press method
					left.press = function(){
						//console.log("LEFT!");
						if(title === true){
							//change ship
							if(shipNo === 1){
								//titleShip.setTexture(resources["images/spaceship2.png"].texture);
								//titleShip.texture = Texture.fromImage("images/spaceship2.png");
								shipNo = 2;
								changeTitleShip(); //test
							}
							else if(shipNo === 2){
								//titleShip.setTexture(resources["images/spaceship1.png"].texture);
								//titleShip.texture = Texture.fromImage("images/spaceship1.png");
								shipNo = 1;
								changeTitleShip(); //test
							}

							playMusic(sfx1p, osfxtype.Shift); //change ship sfx

						} else{
							if(startup === false && endGame === false){
								//Change player's velocity
								playervx = (-5 - wavesNo).clamp(-7, -5);
								playervy = 0;
							}
							
						}
					}

					//Left arrow key release method
					left.release = function(){
						if(title === true){

						} else{
							if(startup === false && endGame === false){
								//If arrow key is released 
								//and player isn't moving vertically
								//Stop player
								if(!right.isDown && playervy === 0){
									playervx = 0;
								}
							}
							
						}
					};

					//Up
					up.press = function(){
						if(title !== true && startup !== true && endGame !== true){
							playervx = 0;
							playervy = (-5 - wavesNo).clamp(-7, -5);
						}
					};
					up.release = function(){
						if(title !== true && startup !== true && endGame !== true){
							if(!down.isDown && playervx === 0){
								playervy = 0;
							}
						}
					};

					//Right
					right.press = function(){
						//console.log("RIGHT!");
						if(title === true){
							//change ship
							if(shipNo === 1){
								//titleShip.setTexture(resources["images/spaceship2.png"].texture);
								//titleShip.texture = Texture.fromImage("images/spaceship2.png");
								shipNo = 2;
								changeTitleShip(); //test
							}
							else if(shipNo === 2){
								//titleShip.setTexture(resources["images/spaceship1.png"].texture);
								//titleShip.texture = Texture.fromImage("images/spaceship1.png");
								shipNo = 1;
								changeTitleShip(); //test
							}

							playMusic(sfx1p, osfxtype.Shift); //change ship sfx

						} else{
							if(startup === false && endGame === false){
								playervx = (5 + wavesNo).clamp(5, 7);
								playervy = 0;
							}
						}
					};
					right.release = function(){
						if(title !== true && startup !== true && endGame !== true){
							if(!left.isDown && playervy === 0){
								playervx = 0;
							}
						}
					};

					//Down
					down.press = function(){
						if(title !== true && startup !== true && endGame !== true){
							playervx = 0;
							playervy = (5 + wavesNo).clamp(5, 7);
						}
					};
					down.release = function(){
						if(title !== true && startup !== true && endGame !== true){
							if(!up.isDown && playervx === 0){
								playervy = 0;
							}
						}
					};

					//Spacebar fire
					spacebar.press = function(){
						if(title === true){
							if(shipNo === 1){
								//player.setTexture(resources["images/spaceship1.png"].texture);
								//player.texture = Texture.fromImage("images/spaceship1.png");
								playerAnimate(10, 350); //test
							} 
							else if(shipNo === 2){
								//player.setTexture(resources["images/spaceship2.png"].texture);
								//player.texture = Texture.fromImage("images/spaceship2.png");
								playerAnimate(10, 350); //test
							}

							titleScene.visible = false;
							gameScene.visible = true;
							title = false;

							playMusic(sfx1p, osfxtype.Click); //select sfx
							playMusic(bgmp, bgmtype.Game); //play game bgm

							setTimeout(function(){ //delay hide tutorial text
								gameScene.removeChild(tutorialTxt1);
								gameScene.removeChild(tutorialTxt2);
							}, 5000);

						} else{
							if(startup === false){
								//psfx[0].play(); //player fire sfx
								playMusic(sfx1p, psfxtype.Fire); //player fire sfx
								firing = true;
							}
							if(endGame === true){
								location.reload(); //reload app
							}
						}
					};

					spacebar.release = function(){
						if(title !== true && startup !== true && endGame !== true){
							firing = false;
						}
					};


					//X button
					xbtn.press = function(){
						//Game quit
						if(title === true){
							console.log("QUIT!");
							window.setTimeout(closeWindow(), 1000); //redirect to pixi.js website
						}
					};

					xbtn.release = function(){

					};


					//Create text sprite
					livesNo = 3; //set max lives 
					livesTxt = new PIXI.Text( 
						"Lives: " + livesNo.toString(), 
						//{font: "18px LCD solid", fill:"white"} 
						{fontFamily: "lcd_solidregular, Courier New", fontSize: "18px", fill: "white"}
					);
					livesTxt.position.set(10, 10); 
					gameScene.addChild(livesTxt); 

					wavesTxt = new PIXI.Text(
						"Wave: " + wavesNo.toString(),
						//{font: "18px LCD solid", fill:"white"}
						{fontFamily: "lcd_solidregular, Courier New", fontSize: "18px", fill: "white"}
					);
					wavesTxt.position.set(10, 40);
					gameScene.addChild(wavesTxt);

					//in-game tutorial text
					tutorialTxt1 = new PIXI.Text(
						"Press ARROW KEYS to navigate",
						{fontFamily: "lcd_solidregular, Courier New", fontSize: "25px", fill: "#14e06c"}
					);
					tutorialTxt1.position.set(120, 80);
					gameScene.addChild(tutorialTxt1);

					tutorialTxt2 = new PIXI.Text(
						"Press SPACEBAR to shoot",
						{fontFamily: "lcd_solidregular, Courier New", fontSize: "25px", fill: "#e0187f"}
					);
					tutorialTxt2.position.set(155, 120);
					gameScene.addChild(tutorialTxt2);


					//init game over screen
					endGame = false; //reset end game identifier
					gameOverScene = new Container();
					stage.addChild(gameOverScene);
					gameOverScene.visible = false; //hide gameover screen on startup

					 gameoverTxt = new PIXI.Text(
					   "GAME OVER!", 
					   //{font: "70px LCD Solid", fill: "white"}
					   {fontFamily: "lcd_solidregular, Courier New", fontSize: "70px", fill: "white"}
					 );
					 gameoverTxt.position.set(145, stage.height / 2);
					 gameOverScene.addChild(gameoverTxt);

					 gameoverTxt2 = new PIXI.Text(
					 	"Press SPACEBAR to continue defending earth",
					 	//{font:"20px LCD Solid", fill:"white"}
					 	{fontFamily: "lcd_solidregular, Courier New", fontSize: "20px", fill: "white"}
					 );
					 gameoverTxt2.position.set(95, (stage.height / 2) + 100);
					 gameOverScene.addChild(gameoverTxt2);

					 //titlescreen 
					 //gameScene.visible = false; //hide game in title
					 //title = false; //hide title identifier on startup
					 titleScene = new Container();
					 stage.addChild(titleScene);

					 //Title screen
					 titleText1 = new PIXI.Text(
					 	"OUTTA SPACE",
					 	//{font: "80px LCD Solid, Courier New", fill: "#ccccff"}
					 	{fontFamily: "lcd_solidregular, Courier New", fontSize: "80px", fill: "#ccccff"}
					 );
					 titleText1.position.set(85, ((stage.height / 2) - 110));
					 titleScene.addChild(titleText1);
					 
					 titleText2 = new PIXI.Text(
					 	"Press SPACEBAR to start",
					 	//{font: "29px LCD Solid", fill:"#99ff33"}
					 	{fontFamily: "lcd_solidregular, Courier New", fontSize: "29px", fill:"#99ff33"}
					 );
					 titleText2.position.set(145, (stage.height / 2) + 175);
					 titleScene.addChild(titleText2);

					 titleText3 = new PIXI.Text(
					 	"Press LEFT / RIGHT arrow to change ship",
					 	//{font: "15px LCD Solid", fill:"#cc66ff"}
					 	{fontFamily: "lcd_solidregular, Courier New", fontSize: "15px", fill: "#cc66ff"}
					 );
					 titleText3.position.set(170, (stage.height / 2) + 130);
					 titleScene.addChild(titleText3);

					 titleText4 = new PIXI.Text(
					 	"by Jan Renz Medina",
					 	//{font: "15px LCD Solid", fill: "#ffff66"}
					 	{fontFamily: "lcd_solidregular, Courier New", fontSize: "15px", fill: "#ffff66"}
					 );
					 titleText4.position.set(255, (stage.height / 2) + 255);
					 titleScene.addChild(titleText4);

					 titleText5 = new PIXI.Text(
					 	"Press X to quit",
					 	//{font: "16px LCD Solid", fill: "red"}
					 	{fontFamily: "lcd_solidregular, Courier New", fontSize: "16px", fill: "red"}
					 );
					 titleText5.position.set(260, (stage.height / 2) + 185);
					 titleScene.addChild(titleText5);

					 //Title Ship selection
					 shipNo = 1; //init ship no
					 //titleShip = new Sprite(resources["images/spaceship1.png"].texture);
					 //titleShip.position.set(310, (stage.height / 2) + 20);
					 //titleScene.addChild(titleShip);
					 initTitleShip(290, (stage.height / 2) + 5); //test


					arrowLeft = new Sprite(resources["images/arrow-left.png"].texture);
					arrowLeft.position.set(200, (stage.height / 2) + 35, false);
					titleScene.addChild(arrowLeft);

					arrowRight = new Sprite(resources["images/arrow-right.png"].texture);
					arrowRight.position.set(450, (stage.height / 2) + 35);
					titleScene.addChild(arrowRight);

					gameScene.visible = false; //hide game in title

					//Splash scene
					//startup = true; //set startup identifier
					titleScene.visible = false; //hide titlescreen on startup
					splashScene = new Container();
					stage.addChild(splashScene);

					//splashImg = new Sprite(resources["images/enemyship1.png"].texture);
					//splashImg.position.set(300, (stage.height / 2) + 50);
					//splashScene.addChild(splashImg);
					spinStartup(300, (stage.height / 2) + 50); //animated ufo in startup

					splashText = new PIXI.Text(
						"HOLY MOTHERSHIP. Just look at those\n\naliens. Do you want those flying\n\n disks unload slimy creatures that\n\n would go and suck our brains or\n\n whatnot? No? Then get them\n\n           OUTTA SPACE!",
						//{font:"28px LCD Solid", fill:"white"}
						{fontFamily: "lcd_solidregular, Courier New", fontSize: "28px", fill: "white"}
					);
					splashText.position.set(60, (stage.height / 2) + 130);
					splashScene.addChild(splashText);	

					//State init
					titleScene.visible = false; //hide
					splashScene.visible = true; //show splash scene on startup
					gameScene.visible = false; //hide

					title = false;
					startup = true; //set startup splash identifier

					playMusic(bgmp, bgmtype.Startup); //play startup bgm

					//set startup game state
					state = play;
	
					//start game loop
					update();
				}

				function update(){

					if(endGame === false){
						//move parallax bg
						space.tilePosition.x -= (0.128 + wavesNo).clamp(0.1, 1.8);
					}

					//Loop function per 60 frames
					requestAnimationFrame(update);

					//Update game state [play, etc]
					//checkState();
					state();
					//console.log("CURRENT STATE: " + state.toString());

					//Render stage
					renderer.render(stage); 
				}

				function checkState(){
					/*if(startup === true){
						state = gameStartup;
					} 
					else if(title === true){
						state = gameTitle;
					}
					else {
						//Gameplay
						state = play;
					}*/

					state = play;
				}

				function play(){
					if(endGame === true){ //game end
						gameEnd();
					} else{ //game still not end
						//Game in progress
						if(title === false && startup === false){
							
							//if game is not in titlescreen
							//move player using its velocity
							player.x += playervx;//player.vx;
							player.y += playervy;//player.vy;

							//Clamp player pos
							/*if(player.x <= 5){ //x axis
								player.x = 5;
							}
							if(player.x >= 630){
								player.y = 630;
							}

							if(player.y <= 10){ //y axis
								player.y = 10;
							}
							if(player.y >= 430){
								player.y = 430;
							}*/

							contain(player, {x:5, y:10, width:650, height:500}); //clamp player pos

							//player fire
							if(firing){
								if(shipNo === 1){
									pfire[0].x = player.x + 25;
									pfire[0].y = player.y + 40;
									pfire[0].vx = 0;
									pfire[0].vy = 0;
									pfire[0].visible = true;
								}
								
								if(shipNo === 2){ //test set 4 bullets pos
									pfire[0].x = player.x + 5;
									pfire[0].y = player.y;
									pfire[0].vx = 0;
									pfire[0].vy = 0;
									pfire[0].visible = true;

									pfire[1].x = player.x + 15;
									pfire[1].y = player.y + 15;
									pfire[1].vx = 0;
									pfire[1].vy = 0;
									pfire[1].visible = true;

									pfire[2].x = player.x + 15;
									pfire[2].y = player.y + 30;
									pfire[2].vx = 0;
									pfire[2].vy = 0;
									pfire[2].visible = true;

									pfire[3].x = player.x + 5;
									pfire[3].y = player.y + 45;
									pfire[3].vx = 0;
									pfire[3].vy = 0;
									pfire[3].visible = true;
								}
							}

							//Fire collision check
							if(shipNo === 1){
								if(pfire[0].visible === true){
									pfire[0].x += 6; //move player bullet forward
									
									/*var rand = Math.floor((Math.random() * 3) + 1);
									if(rand === 1){
										pfire[0].y += 0;
										console.log("TEST1");
									} 
									if(rand === 2){
										pfire[0].y += 1;
										console.log("TEST2");
									} 
									if(rand === 3){
										pfire[0].y -= 1;
										console.log("TEST3");
									}*/
								}
							}
							
							else if(shipNo === 2){ //test
									pfire[0].x += 6;
									pfire[1].x += 6;
									pfire[2].x += 6;
									pfire[3].x += 6;

									for(var i = 0; i < 3; i++){
										//pfire[i].x += 6;

										if(pfire[i].x > 750){ //clamp bullet pos
											pfire[i].visible = false;
										}
									}
							}


							if(efire[0].visible === true){
								//move enemy fire forward
								efire[0].x -= 4 + wavesNo;
								//efire[0].y -= 0;

								//clamp enemy fire
								if(efire[0].x <= -15){
									efire[0].visible = false;
								}

								//eplayer hit by enemyfire
								if(detectCollision(player, efire[0])){ 
									if(efire[0].visible === true){
										livesNo--;
										livesNo.clamp(0, 3);
										livesTxt.text = "Lives: " + livesNo.toString();

										playMusic(sfx1p, psfxtype.Hit);

										efire[0].visible = false; //hide enemy bullet after hit
									}	
								}
							}

							var nextWave = true; //init next wave identifier

							//check for collision 
							for(var i = 0; i < enemySpin.length; i++){

								//move enemy
								if(enemySpin[i].visible === true){ //if enemy is visible
									enemySpin[i].x -= 2 + wavesNo;

									if(efire[0].visible === false){
										efire[0].x = enemySpin[i].x;
										efire[0].y = enemySpin[i].y;
										efire[0].visible = true;

										playMusic(sfx2p, esfxtype.Fire); //enemy fire sfx
									}

									//Enemy pass
									if(enemySpin[i].x < -40){
										livesNo--;
										livesNo.clamp(0, 3);
										livesTxt.text = "Lives: " + livesNo.toString();
										enemySpin[i].visible = false;

										playMusic(sfx2p, esfxtype.Pass); //enemy pass sfx
									}

									nextWave = false; //set next wave identifier
								} else{ //enemy is invisible

								}

								//if there's collision
								if(detectCollision(player, enemySpin[i])){ 
									//if enemy is active
									if(enemySpin[i].visible === true){
										livesNo--;
										livesNo.clamp(0, 3);
										livesTxt.text = "Lives: " + livesNo.toString();
										psfx[3].play(); //player hit sfx

										enemySpin[i].visible = false;
										console.log("HIT!");
										//perform explosion anim here
										explode(enemySpin[i].x, enemySpin[i].y);

										playMusic(sfx2p, esfxtype.Hit); //enemy hit sfx
										playMusic(sfx2p, esfxtype.Explode); //enemy explode sfx
									}
								} 

								//enemy hit by player fire
								if(shipNo === 1){
									if(detectCollision(enemySpin[i], pfire[0])){
										//if enemy is active
										if(enemySpin[i].visible === true){
											enemySpin[i].visible = false;
											pfire[0].visible = false;
											//perform explosion anim here
											explode(enemySpin[i].x, enemySpin[i].y);

											playMusic(sfx2p, esfxtype.Hit); //enemy hit sfx
											playMusic(sfx2p, esfxtype.Explode); //enemy explode sfx
										}
									}
								}
								else if(shipNo === 2){ //test
									for(var k = 0; k < 3; k++){
										if(detectCollision(enemySpin[i], pfire[k])){
											//if enemy is active
											if(enemySpin[i].visible === true){
												enemySpin[i].visible = false;
												pfire[k].visible = false;
												//perform explosion anim here
												explode(enemySpin[i].x, enemySpin[i].y);

												playMusic(sfx2p, esfxtype.Hit); //enemy hit sfx
												playMusic(sfx2p, esfxtype.Explode); //enemy explode sfx
											}
										}
									}
									
								}	
								

								else{
									//no collision
								}

							}

							//Next wave
							if(nextWave === true){
								wavesNo += 1;
								wavesTxt.text = "Wave: " + wavesNo.toString();
								nextWave = false; //reset next wave identifier
								setupWave(); //setup new wave
							}

							//Dead player
							if(livesNo <= 0){
								livesNo = 0;
								livesTxt.text = "Lives: " + livesNo.toString();
								player.visible = false;
								explode(player.x, player.y);
								endGame = true;

								playMusic(sfx1p, psfxtype.Explode); //play player explode sfx
								playMusic(bgmp, bgmtype.Gameover); //play gameover bgm

								//savefile
								if(wavesNo > maxWaveData){ //if there's a new highscore
									maxWaveData = wavesNo; //set savedata
									localStorage.maxWaveData = JSON.stringify(maxWaveData); //save data
									console.log("Saved data: " + JSON.parse(localStorage.maxWaveData)); //test
								}
							}
						} else{ 
							if(title === true){ //titlescreen ops
								gameTitle();
							} 
							else if(startup === true){ //startup ops
								setTimeout(function(){gameStartup();}, 7000); //delay execute startup ops
							}
						}
						
					}
				}

				//Explosion anim
				function explode(x, y){
					var frames = [];

					for(var i = 0; i < 34; i++){
						frames.push(Texture.fromFrame("images/explosion" + (i + 1) + ".png"));
					}

					explosion = new PIXI.extras.MovieClip(frames);
					explosion.position.set(x, y);
					explosion.anchor.set(0.5);
					explosion.animationSpeed = 0.5;
					explosion.loop = false;

					explosion.play();

					gameScene.addChild(explosion);

					//Hide explosion after less than 1 sec
					setTimeout(function(){
						explosion.visible = false;
					}, 900);
				}

				//Enemy spin anim
				function spinEnemy(x, y, id){
					var frames = [];

					for(var i = 0; i < 12; i++){
						frames.push(Texture.fromFrame("images/enemyship" + (i + 1) + ".png"));
					}

					enemySpin[id] = new PIXI.extras.MovieClip(frames);
					enemySpin[id].position.set(x, y);
					//enemySpin[id].anchor.set(0.5);
					enemySpin[id].animationSpeed = 0.5;
					enemySpin[id].loop = true;

					enemySpin[id].play();

					gameScene.addChild(enemySpin[id]);
				}

				//Player ship anim
				function playerAnimate(x, y){
					var frames = [];

					if(shipNo === 1){
						for(var i = 0; i < 3; i++){
							frames.push(Texture.fromFrame("images/p1ship" + (i + 1) + ".png"));
						}
					}
					else if(shipNo === 2){
						for(var i = 0; i < 3; i++){
							frames.push(Texture.fromFrame("images/p2ship" + (i + 1) + ".png"));
						}
					}

					player = new PIXI.extras.MovieClip(frames);
					player.position.set(x, y);
					player.animationSpeed = 0.2;
					player.loop = true;

					player.play();

					gameScene.addChild(player);
				}

				//Player ship title anim
				function initTitleShip(x, y){
					var frames = [];

					if(shipNo === 1){
						for(var i = 0; i < 3; i++){
							frames.push(Texture.fromFrame("images/p1ship" + (i + 1) + ".png"));
						}
					}
					else if(shipNo === 2){
						for(var i = 0; i < 3; i++){
							frames.push(Texture.fromFrame("images/p2ship" + (i + 1) + ".png"));
						}
					}

				
					titleShip = new PIXI.extras.MovieClip(frames); 
					titleShip.position.set(x, y);
					titleShip.animationSpeed = 0.2;
					titleShip.loop = true;

					titleShip.play();

					titleScene.addChild(titleShip);
					console.log("INIT TITLESHIP");
				}

				function changeTitleShip(){
					var frames = [];

					if(shipNo === 1){
						for(var i = 0; i < 3; i++){
							frames.push(Texture.fromFrame("images/p1ship" + (i + 1) + ".png"));
						}
					}
					else if(shipNo === 2){
						for(var i = 0; i < 3; i++){
							frames.push(Texture.fromFrame("images/p2ship" + (i + 1) + ".png"));
						}
					}

					titleShip.textures = frames;

					//titleShip.position.set(290, (stage.height / 2) + 5);
					/*if(shipNo === 1){
						titleShip.position.y = ((stage.height / 2) + 5);
					}
					else if(shipNo === 2){
						titleShip.position.y = ((stage.height / 2) + 20);
					}*/

				}

				//enemy spin anim in startup splash
				function spinStartup(x, y){
					var frames = [];

					for(var i = 0; i < 12; i++){
						frames.push(Texture.fromFrame("images/enemyship" + (i + 1) + ".png"));
					}

					splashImg = new PIXI.extras.MovieClip(frames);
					splashImg.position.set(x, y);
					//splashImg.anchor.set(0.5);
					splashImg.animationSpeed = 0.5;
					splashImg.loop = true;

					splashImg.play();

					splashScene.addChild(splashImg);
				}

				//Titlescreen ops
				function gameTitle(){
					if(title === true){

					}
				}

				//Startup splash ops(delay)
				function gameStartup(){
					if(startup === true){
						startup = false;
						title = true;
						splashScene.visible = false;
						titleScene.visible = true;
						shipNo = 1;
								
						playMusic(bgmp, bgmtype.Title); //play title bgm

						console.log("Start Titlescreen!");
					}
				}

				function playMusic(musicPlayer, audioType){ //play music
					var bg = musicPlayer === bgmp? true:false;
					var sfxp = musicPlayer === sfx1p || musicPlayer === sfx2p? true:false;

					if(bg === true){ //bgm
						if(audioType === bgmtype.Startup){
							sfx1p = osfx[0]; //startup sfx play
							sfx1p.play();
						}
						else if(audioType === bgmtype.Title){
							sfx1p.pause(); //stop startup bgm
							bgmp = bgm[2];
							bgmp.addEventListener('ended', function() {
							    this.currentTime = 0;
							    this.play();
							}, false);
							bgmp.play(); //title screen bgm
						}
						else if(audioType === bgmtype.Game){
							bgmp = bgm[0]; //start game bgm
							bgmp.addEventListener('ended', function() {
							    this.currentTime = 0;
							    this.play();
							}, false);
							bgmp.play();
						} 
						else if(audioType === bgmtype.Gameover){
							setTimeout(function(){
								bgmp.pause(); //stop game bgm
								sfx1p = psfx[2]; //gameover sfx
								sfx1p.play(); 
							}, 400);
						}
					}
					else if(sfxp === true){ //sound fx
						if(audioType === psfxtype.Fire){ //player fire sfx
							sfx1p = psfx[0];
							sfx1p.play(); 
						}
						else if(audioType === psfxtype.Explode){ //player explode sfx
							sfx1p = psfx[1]; 
							sfx1p.play();
						}
						else if(audioType === psfxtype.Hit){ //player hit sfx
							sfx1p = psfx[3]; 
							sfx1p.play();
						} 
						else if(audioType === esfxtype.Fire){ //enemy fire sfx
							sfx2p = esfx[0]; 
							sfx2p.play();
						}
						else if(audioType === esfxtype.Explode){ //enemy explode sfx
							setTimeout(function(){ //explosion sfx delay 
								sfx2p = esfx[1]; 
								sfx2p.play();
							}, 400);
						}
						else if(audioType === esfxtype.Pass){ //enemy pass sfx
							sfx2p = esfx[2]; 
							sfx2p.play();
						}
						else if(audioType === esfxtype.Hit){ //enemy hit sfx
							sfx2p = esfx[3];
							sfx2p.play();
						} else if(audioType === osfxtype.Click){ //select sfx
							sfx1p == osfx[3]; 
							sfx1p.play();
						} else if(audioType === osfxtype.Shift){ //change ship sfx
							sfx1p = osfx[2]; 
							sfx1p.play();
						}
					}
				}

				function closeWindow() {
				    stage.destroy();
					renderer.destroy();
					window.location = "http://www.pixijs.com/";
				}

				//Game over ops
				function gameEnd(){
					setTimeout(function(){
						gameOverScene.visible = true;
						document.body.style.backgroundColor = "black"; 
						gameScene.visible = false; //hide game
						splashScene.destroy;
						bgScene.visible = false; //hide bg
						performCleanup(); //cleanup unused objects
					}, 1500);
				}

				function performCleanup(){
					//splash
					splashScene.removeChild(splashText);
					splashScene.removeChild(splashImg);

					//titlescreen
					titleScene.removeChild(titleText1);
					titleScene.removeChild(titleText2);
					titleScene.removeChild(titleText3);
					titleScene.removeChild(titleText4);
					titleScene.removeChild(titleText5);
					titleScene.removeChild(titleShip);

					//Detach stage children
					stage.removeChild(splashScene);
					stage.removeChild(titleScene);
					stage.removeChild(gameScene);
				}

				//Setup waves
				function setupWave(){
					enemySpin = []; //reset array of enemies

					//create new enemy wave
					for(var i = 0; i < 10 * wavesNo; i++){
						//enemySpin[i] = new Sprite(resources["images/enemyship1.png"].texture);
						//enemy[i].x = (800 + (400 * (i - wavesNo)));
						//enemy[i].y = (50 + ((Math.floor((Math.random() * 400) + 1)))).clamp(15, 400);
						//gameScene.addChild(enemy[i]);

						//Generated enemy position
						var eX = (800 + (400 * i)); //generated x val 
						var eY = (50 + ((Math.floor((Math.random() * 400) + 1)))).clamp(15, 400); //generated y val 

						//Enemy animation
						spinEnemy(eX, eY, i);
					}

					osfx[1].play(); //play next wave sfx
				}

				function detectCollision(r1, r2){

					  //Define the variables we'll need to calculate
					  var hit, combinedHalfWidths, combinedHalfHeights, vx, vy;

					  //hit will determine whether there's a collision
					  hit = false;

					  //Find the center points of each sprite
					  r1.centerX = r1.x + r1.width / 2; 
					  r1.centerY = r1.y + r1.height / 2; 
					  r2.centerX = r2.x + r2.width / 2; 
					  r2.centerY = r2.y + r2.height / 2; 

					  //Find the half-widths and half-heights of each sprite
					  r1.halfWidth = r1.width / 2;
					  r1.halfHeight = r1.height / 2;
					  r2.halfWidth = r2.width / 2;
					  r2.halfHeight = r2.height / 2;

					  //Calculate the distance vector between the sprites
					  vx = r1.centerX - r2.centerX;
					  vy = (r1.centerY) - (r2.centerY);

					  //Figure out the combined half-widths and half-heights
					  if(shipNo === 1){ //test
					  		combinedHalfWidths = r1.halfWidth + (r2.halfWidth / 4);
					  }
					  else{
					  		combinedHalfWidths = r1.halfWidth + (r2.halfWidth / 2);
					  }
					  
					  combinedHalfHeights = r1.halfHeight + (r2.halfHeight / 2);

					  //Check for a collision on the x axis
					  if (Math.abs(vx) < combinedHalfWidths) {

					    //A collision might be occuring. Check for a collision on the y axis
					    if (Math.abs(vy) < combinedHalfHeights) {

					      //There's definitely a collision happening
					      hit = true;
					    } else {

					      //There's no collision on the y axis
					      hit = false;
					    }
					  } else {

					    //There's no collision on the x axis
					    hit = false;
					  }

					  //`hit` will be either `true` or `false`
					  return hit;
				}

				//Clamp sprite pos
				function contain(sprite, container) {

				  var collision = undefined;

				  //Left
				  if (sprite.x < container.x) {
				    sprite.x = container.x;
				    collision = "left";
				  }

				  //Top
				  if (sprite.y < container.y) {
				    sprite.y = container.y;
				    collision = "top";
				  }

				  //Right
				  if (sprite.x + sprite.width > container.width) {
				    sprite.x = container.width - sprite.width;
				    collision = "right";
				  }

				  //Bottom
				  if (sprite.y + sprite.height > container.height) {
				    sprite.y = container.height - sprite.height;
				    collision = "bottom";
				  }

				  //Return the `collision` value
				  return collision;
				}


				//The `keyboard` helper function
				function keyboard(keyCode) {
				  var key = {};
				  key.code = keyCode;
				  key.isDown = false;
				  key.isUp = true;
				  key.press = undefined;
				  key.release = undefined;
				  //The `downHandler`
				  key.downHandler = function(event) {
				    if (event.keyCode === key.code) {
				      if (key.isUp && key.press) key.press();
				      key.isDown = true;
				      key.isUp = false;
				    }
				    event.preventDefault();
				  };

				  //The `upHandler`
				  key.upHandler = function(event) {
				    if (event.keyCode === key.code) {
				      if (key.isDown && key.release) key.release();
				      key.isDown = false;
				      key.isUp = true;
				    }
				    event.preventDefault();
				  };

				  //Attach event listeners
				  window.addEventListener(
				    "keydown", key.downHandler.bind(key), false
				  );
				  window.addEventListener(
				    "keyup", key.upHandler.bind(key), false
				  );
				  return key;
				}

				//Helper functions

				/**
				 * Returns a number whose value is limited to the given range.
				 *
				 * Example: limit the output of this computation to between 0 and 255
				 * (x * 255).clamp(0, 255)
				 *
				 * @param {Number} min The lower boundary of the output range
				 * @param {Number} max The upper boundary of the output range
				 * @returns A number in the range [min, max]
				 * @type Number
				 */
				Number.prototype.clamp = function(min, max) {
				  return Math.min(Math.max(this, min), max);
				};

		</script>

	</body>

</html>